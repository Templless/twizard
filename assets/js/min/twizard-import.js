!function(e,a){"use strict";a={selectors:{trigger:"#twizard-import-start",advancedTrigger:'button[data-action="start-install"]',popupTrigger:'button[data-action="confirm-install"]',removeContent:'button[data-action="remove-content"]',upload:"#twizard-file-upload",globalProgress:"#twizard-import-progress"},globalProgress:null,init:function(){e(function(){a.globalProgress=e(a.selectors.globalProgress).find(".twiz-progress__bar"),e("body").on("click.twizImport",a.selectors.trigger,a.goToImport).on("click.twizImport",a.selectors.advancedTrigger,a.advancedImport).on("click.twizImport",a.selectors.popupTrigger,a.confirmImport).on("click.twizImport",a.selectors.removeContent,a.removeContent).on("focus.twizImport",".twiz-remove-form__input",a.clearRemoveNotices).on("change.twizImport",'input[name="install-type"]',a.advancedNotice).on("click.twizImport",".twiz-advanced-popup__close",a.closePopup),e(document).on("twizard-install-finished",a.wizardPopup),window.TwizardDataImportVars.autorun&&a.startImport(),void 0!==window.TwizardRegenerateData&&a.regenerateThumbnails(),a.fileUpload()})},wizardPopup:function(){e(".twiz-advanced-popup").removeClass("popup-hidden").trigger("twiz-popup-opened")},removeContent:function(){var t=e(this),r=t.prev(),o=t.closest(".twiz-remove-form"),s=e(".twiz-remove-form__notices",o),i={};t.hasClass("in-progress")||(i.action="twizard-import-remove-content",i.nonce=window.TwizardDataImportVars.nonce,i.password=r.val(),t.addClass("in-progress"),e.ajax({url:window.ajaxurl,type:"post",dataType:"json",data:i,error:function(){t.removeClass("in-progress")}}).done(function(e){1==e.success?(o.addClass("content-removed").html(e.data.message),a.startImport()):(s.addClass("twiz-error").removeClass("twiz-hide"),s.html(e.data.message)),t.removeClass("in-progress")}))},clearRemoveNotices:function(){var a=e(this),t=a.closest(".twiz-remove-form"),r=e(".twiz-remove-form__notices",t);r.removeClass("twiz-error").addClass("twiz-hide")},closePopup:function(){e(".twiz-advanced-popup").addClass("popup-hidden").data("url",null),e(".twiz-btn.in-progress").removeClass("in-progress")},confirmImport:function(){var a=e(this),t=a.closest(".twiz-advanced-popup"),r=e('.twiz-advanced-popup__item input[type="radio"]:checked',t),o="append",s=t.data("url");a.addClass("in-progress"),void 0!==r.val()&&""!==r.val()&&(o=r.val()),s=s+"&type="+o,window.location=s},advancedImport:function(){var a=e(this),t=a.closest(".advanced-item"),r=e('.advanced-item__type-checkbox input[type="checkbox"]',t),o=window.TwizardDataImportVars.advURLMask,s=t.data("full"),i=t.data("lite");a.addClass("in-progress"),o=r.is(":checked")?o.replace("<-file->",i):o.replace("<-file->",s),e(".twiz-advanced-popup").removeClass("popup-hidden").data("url",o)},advancedNotice:function(){var a=e(this),t=a.closest(".twiz-advanced-popup__content"),r=e(".twiz-advanced-popup__warning",t);a.is(":checked")&&"replace"===a.val()?r.removeClass("twiz-hide"):r.hasClass("twiz-hide")||r.addClass("twiz-hide")},regenerateThumbnails:function(){var e={action:"twizard-regenerate-thumbnails",offset:0,step:window.TwizardRegenerateData.step,total:window.TwizardRegenerateData.totalSteps};a.ajaxRequest(e)},ajaxRequest:function(t){var r;t.nonce=window.TwizardDataImportVars.nonce,t.file=window.TwizardDataImportVars.file,e.ajax({url:window.ajaxurl,type:"get",dataType:"json",data:t,error:function(){t.step?(r=Math.ceil(100*(t.offset+t.step)/(t.total*t.step)),a.globalProgress.css("width",r+"%").find(".twiz-progress__label").text(r+"%"),t.offset=t.offset+t.step,a.ajaxRequest(t)):e("#twizard-import-progress").replaceWith('<div class="import-failed">'+window.TwizardDataImportVars.error+"</div>")}}).done(function(t){!0!==t.success||t.data.isLast||a.ajaxRequest(t.data),t.data&&t.data.redirect&&(window.location=t.data.redirect),t.data&&t.data.complete&&(a.globalProgress.css("width",t.data.complete+"%").find(".twiz-progress__label").text(t.data.complete+"%").closest(".twiz-progress__bar").next(".twiz-progress__sub-label").text(t.data.complete+"%"),a.globalProgress.siblings(".twiz-progress__placeholder").remove()),t.data&&t.data.processed&&e.each(t.data.processed,a.updateSummary)})},updateSummary:function(a,t){var r=e('tr[data-item="'+a+'"]'),o=parseInt(r.data("total")),s=e(".twiz-install-summary__done",r),i=e(".twiz-install-summary__percent",r),n=e(".twiz-progress__bar",r),d=e(".twiz-progress-status",r),c=Math.round(parseInt(t)/o*100);s.hasClass("is-finished")||(100===c&&(s.addClass("is-finished").closest("td").addClass("is-finished"),d.html('<span class="dashicons dashicons-yes"></span>')),s.html(t),i.html(c),n.css("width",c+"%"))},startImport:function(){var e={action:"twizard-import-chunk",chunk:1};a.ajaxRequest(e)},prepareImportArgs:function(){var a=null,t=e('input[name="upload_file"]'),r=e('select[name="import_file"]');return t.length&&""!==t.val()&&(a=t.val()),r.length&&null==a&&(a=e("option:selected",r).val()),"&tab="+window.TwizardDataImportVars.tab+"&step=2&file="+a},goToImport:function(){var t=e('input[name="referrer"]').val();e(this).hasClass("disabled")||(window.location=t+a.prepareImportArgs())},fileUpload:function(){var t=e(a.selectors.upload),r=t.closest(".import-file"),o=r.find(".import-file__placeholder"),s=r.find(".import-file__input"),i=wp.media.frames.file_frame=wp.media({title:window.TwizardDataImportVars.uploadTitle,button:{text:window.TwizardDataImportVars.uploadBtn},multiple:!1}),n=function(){return i.open(),!1},d=function(){var e=i.state().get("selection").toJSON(),t=e[0];o.val(t.url),a.getFilePath(t.url,s)};t.on("click",n),i.on("select",d)},getFilePath:function(t,r){var o=e(a.selectors.trigger);o.addClass("disabled"),e.ajax({url:window.ajaxurl,type:"get",dataType:"json",data:{action:"twizard-import-get-file-path",file:t,nonce:window.TwizardDataImportVars.nonce},error:function(){return o.removeClass("disabled"),!1}}).done(function(e){o.removeClass("disabled"),!0===e.success&&r.val(e.data.path)})}},a.init()}(jQuery,window.TwizardDataImport);